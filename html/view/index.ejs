<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Gossip girl</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="./index.css" type="text/css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/520e072e3a.js" crossorigin="anonymous"></script>
      <script>

          function resizeIframe(obj) {
              obj.style.height = obj.contentWindow.document.documentElement.scrollHeight.toString() + 'px';
          }
      </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</head>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  <!-- Toast notification -->

<% if (typeof(toast) != "undefined") { %>
    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 11">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">

            <div class="toast-header">
                <% switch(toast.type) {
                    case 2:
                        %> <i class="fa-solid fa-check toast-icon" style="color:greenyellow;"></i> <%
                    break

                    case 1:
                        %> <i class="fa-solid fa-envelope toast-icon" style="color:black;"></i> <%
                    break
                }
                if (toast.type < 0) {
                    %> <i class="fa-solid fa-xmark toast-icon" style="color:red;"></i> <%
                }%>
                <strong class="me-auto m-2">
                    <%=toast.title%>
                </strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body m-8">
                <%=toast.message%>
            </div>

        </div>
    </div>
<script>
    function showToast() {
        let toastElement = document.getElementById('liveToast')
        let toast = new bootstrap.Toast(toastElement)
        toast.show()
    }
</script>



<body onload="showToast();">
<% } else { %>
<body onload="">
<% } %>
    <%-include('fragments/header.ejs');%>

    <section class="pb-5" style="padding-top: 50px;">
        <div class="">
            <div class="row">
                <div class="col-lg-10 col-xl-8">
                    <div class="p-5 shadow rounded" style=" background-color: #FFFFEA; border: 1px solid black; padding:0!important;">
                        <!-- Bootstrap carousel-->
                        <% if (user.isAdmin) { %>
                        <button class="btn btn-info" type="submit" onClick="javascript:window.location.href='/updateNews';">Update news</button>
                        <% } %>
                        <div class="carousel slide carousel-fade" id="carouselExampleIndicators" data-ride="carousel">
                            <!-- Bootstrap controls [dots]-->
                            <span style="display: table!important; margin: 0 auto!important;">
                            <a class="carousel-control-prev" href="#carouselExampleIndicators" style="margin-right:256px!important;" role="button" data-slide="prev">
                                <i class="fa fa-angle-left text-dark text-lg"></i>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                                <i class="fa fa-angle-right text-dark text-lg"></i>
                                <span class="sr-only">Next</span>
                            </a>
                            </span>
                            <!-- Bootstrap inner [slides]-->

                            <div class="carousel-inner px-5 pb-7">
                                <!-- Carousel slide-->
                                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo0" aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
                                    <span class="navbar-toggler-icon"><i class="fa-solid fa-eye"></i></span>
                                </button>
                                <div class="navbar-collapse collapse" id="navbarTogglerDemo0" style="">
                                <% if (typeof(news) !== undefined && typeof(news) !== 'undefined') { %>
                                <%for(var i=0; i<news.length; i+=3) {%>
                                    <% /*if(news[i].language === "russian" || news[i].language === "english" || news[i].language === "kazakh") {*/%>
                                        <span class="carousel-item d-inline">
                                            <table class="table">
                                            <tr class="row">
                                            <% for(var j=i; j<i+3 && j != news.length; j++) { %>
                                                <td class="media col">
                                                    <% if (news[j].image_url) { %>
                                                    <img class="news-image" src="<%=news[j].image_url%>" alt="" width="75">
                                                    <% } %>
                                                  <blockquote class="blockquote border-0 p-0">
                                                      <% if (news[j].title) { %>
                                                        <p class="news-title"><%=news[j].title%></p>
                                                      <% } %>
                                                      <% if (news[j].description) { %>
                                                        <p class="news-description"><%=news[j].description%></p>
                                                      <% } %>
                                                      <button class="btn btn-secondary" type="submit" onClick="javascript:window.location.href='/createPost?newsLink=<%= news[j].link%>';">Write about that</button>

                                                 </blockquote>
                                            </td>
                                                <%}%>
                                            </tr>
                                            </table>
                                            <tr class="row">
                                                <td class="col">
                                                    <table class="table">
                                                        <tr class="row">
                                                            <% for(var j=i; j<i+3 && j != news.length; j++) { %>
                                                            <td class="col">
                                                            <% if (news[j].link) { %>
                                                            <a title="Source Title" style="position: relative; bottom:0" href="<%=news[j].link%>"><i class="fa-solid fa-info" style=""></i> More info</a>
                                                            <%}%>
                                                            <% if (news[j].content) { %>
                                                            <p style=""><%=news[j].content.slice(0, 1000)%>...</p>
                                                            <%}%>
                                                            </td>
                                                            <%}%>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </span>
                                    <%//}%>
                                <%}%>
                                    <%}%>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <form class="col align-self-center" style="margin: auto;" action="/search" method="get">
                <span class="input-group align-middle">
                    <input type="search" class="form-control" name="word" placeholder="Search..." aria-label="Search" style="margin-bottom: 0!important;">
                    <button type="submit" class="btn btn-outline-success" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Create a new question."><i class="fa-solid fa-magnifying-glass"></i></button>
                </span>
    </form>

    <form method="post" enctype="multipart/form-data" action="/avatar">
        <input type="file" name="file">
        <input type="submit" value="Upload">
    </form>

    <%  if (topics !== undefined) %>
    <%for (let i = 0; i < topics.list.length; i++) { %>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio<%=i%>" value="" onchange="loadMore('<%=topics.list[i]%>')">
            <label class="form-check-label" for="inlineRadio<%=i%>"><%=topics.list[i]%></label>
        </div>
        <!--<button onclick="loadMore('<%=/*topics.list[i]%>')"><%=topics.list[i]*/%></button>-->
    <% } %>


    <div class="container center" id="posts">
    <% if (typeof(posts) !== undefined && typeof(posts) !== 'undefined') { %>
            <% if (posts.length <= 0) { %>
            <div class="container center" style="text-align: center">Nothing found</div>
            <% } %>
            <% for (let i = 0; i < posts.length; i++) { %>
        <iframe onload="resizeIframe(this)" frameborder="0" marginwidth="0" marginheight="0" scrolling="NO" width="100%" height="100%" src="/getPost?topic=undf&index=<%=posts[i]._id%>"></iframe>
            <% } %>
        <% } %>
    <!-- <iframe onload="resizeIframe(this)" frameborder="0" marginwidth="0" marginheight="0" scrolling="NO" width="100%" height="100%" src="/getPost?tag="></iframe> -->

    </div>

    <!-- Load More Button -->
    <div class="container hcenter">
        <button id="load-more-button" type="button" class="btn btn-outline-warning center_button_cards" name="Load_more_cards">Load more cards</button>
    </div>
<div class="chatBox">
    <div style="background-color: yellow; position:absolute;bottom: 0; height:48px; left:-64px; right: 0px;"></div>
    <button onclick="

    if (document.getElementById('chatIframe').style.zIndex > 0) {
        document.getElementById('chatIframe').style.zIndex = -1000
    } else {
        document.getElementById('chatIframe').style.zIndex = 1000
    }

    " class="navbar-toggler" type="button" style="position:absolute; bottom: 0; left: -64px;" data-toggle="collapse" data-target="#iframeToggle" aria-controls="" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"><i class="fa-solid fa-eye"></i></span>
    </button>
</div>
<div class="chatBox" id="chatIframe" style="z-index: -1000!important;">
    <span>
    <div class="navbar-collapse collapse" id="iframeToggle" style="">
    <div class="chatFrame">
    <iframe id="chatBox" class="chatFrame" src="/chat" scrolling="NO"></iframe>
    </div>
    </div>
     </span>
</div>

    <!-- Footer -->
    <div class="footer container-fluid w-100 center py-4 border-top">
        <footer>
            <div class="row">
              <div class="col-4"></div>
              <div class="col-4"></div>
              <div class="col-4">
                    <form>
                        <h5>Subscribe to our newsletter</h5>
                        <p>Monthly digest of whats new and exciting from us.</p>
                        <div class="d-flex w-100 gap-2">
                            <label for="newsletter1" class="visually-hidden">Email address</label>
                            <input id="newsletter1" type="text" class="form-control" placeholder="Email address">
                        <button class="btn btn-primary" type="button">Subscribe</button>
                    </div>
                </form>
              </div>
            </div>

            <div class="d-flex justify-content-between my-4 border-top">
                <p>© 2021 Company, Inc. All rights reserved.</p>
                <ul class="list-unstyled d-flex">
                    <li class="ms-3"><a class="link-dark" href="#"><svg class="bi" width="24" height="24"><use xlink:href="#twitter"></use></svg></a></li>
                    <li class="ms-3"><a class="link-dark" href="#"><svg class="bi" width="24" height="24"><use xlink:href="#instagram"></use></svg></a></li>
                    <li class="ms-3"><a class="link-dark" href="#"><svg class="bi" width="24" height="24"><use xlink:href="#facebook"></use></svg></a></li>
                </ul>
            </div>
        </footer>
    </div>

    <script>

        var index = 0
        var prevType
        var type
        <% if (typeof(posts) !== undefined && typeof(posts) !== 'undefined') { %>
            type = ''
        <% } else { %>
            type = 'All topics'
        <% } %>

        let carousel = document.getElementsByClassName('carousel-item')[0];
        carousel.classList.add('active');

        function httpGet(theUrl)
        {
            var xmlHttp = new XMLHttpRequest()
            xmlHttp.open("GET", theUrl, false)
            xmlHttp.send(null)
            return xmlHttp.responseText
        }

        let loadMoreButton = document.getElementById('load-more-button')
        loadMoreButton.addEventListener('click', () => {
            loadMore()
        })
        function loadMore(tp) {
            if (tp !== null && tp !== undefined) {
                prevType = type
                type = tp
            }
            const err = httpGet("/getPost?topic=" + encodeURI(type) + "&index=" + index)
            let posts = document.getElementById('posts')
            if (prevType !== type) {
                posts.innerHTML = ""
                index = 0
            }
            loadMoreButton.style.visibility = 'visible'
            if (err === 'no') {
                loadMoreButton.style.visibility = 'hidden'
                return false
            }

            var iframe = document.createElement("iframe")
            iframe.frameborder = 0
            iframe.marginwidth = 0
            iframe.marginheight = 0
            iframe.scrolling = "NO"
            iframe.width = "100%"
            iframe.src = "/getPost?topic=" + encodeURI(type) + "&index=" + index
            iframe.addEventListener('load', () => {
                resizeIframe(iframe)
                if (iframe.contentWindow.document.body.innerHTML === 'no')
                    iframe.remove()
            })

            index++
            prevType = type
            posts.append(iframe)
            return true
        }

      //When scrolled down load posts
      window.addEventListener('scroll', (event) => {
          if ((window.innerHeight + window.scrollY) + 100 >= document.body.offsetHeight)
          {
              loadMore(type)
          }
      })
      loadMore(type)
      loadMore(type)
      loadMore(type)

      // Update post height every 100 ms
      setInterval(function() {
          let iframes = document.getElementsByTagName('iframe')
          for (let i = 0; i < iframes.length; i++) {
              if (iframes[i].id !== 'chatBox')
                resizeIframe(iframes[i])
          }
        }, 100);

    </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  </body>
</html>
